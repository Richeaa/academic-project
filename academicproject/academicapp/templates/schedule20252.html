{% extends 'dashboard.html' %}
{% load static %}
{% load get_item %}
{% block title %}Schedule 20252{% endblock %}

{% block content %}
<main id="main-content" class="w-full p-8 lg:ml-64">
    <div class="flex justify-between items-center mb-8">
        <h2 class="text-2xl font-bold text-gray-800">Schedule per Room</h2>
        <div class="flex items-center space-x-2">
            <input type="text" id="roomSearch" placeholder="Search Room..." class="hidden lg:block w-80 pl-10 pr-4 py-3 bg-gray-200 border-0 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white transition-all">
        </div>
    </div>

    {% if not room_schedule %} 
    <div class="flex items-center justify-center min-h-[60vh]">
        <div class="text-center text-gray-400">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mb-2 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span class="text-sm">No room scheduled</span>
        </div>
    </div>
    {% endif %}

    {% if has_conflicts %}
    <div class="mb-8 bg-white rounded-xl shadow-md overflow-hidden border border-red-100">
        <div class="bg-amber-50 px-6 py-4 border-b border-amber-100">
            <div class="flex items-center">
                <svg class="w-5 h-5 text-amber-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                </svg>
                <h3 class="text-lg font-semibold text-amber-800">Schedule Conflicts Detected</h3>
            </div>
        </div>
        <div class="p-6">
            <div class="space-y-4">
                {% for conflict in conflict_details %}
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center bg-white p-4 rounded-lg border border-red-100 shadow-sm hover:shadow-md transition-shadow">
                    <div class="flex-1">
                        <div class="flex items-center mb-2">
                            <span class="inline-block w-3 h-3 rounded-full bg-red-500 mr-2"></span>
                            <span class="text-sm font-medium text-gray-700">{{ conflict.day }} in {{ conflict.room }}</span>
                        </div>
                        <div class="flex flex-wrap items-center gap-2">
                            <div class="flex items-center bg-red-50 px-3 py-1 rounded-full">
                                <span class="text-xs font-medium text-red-700">{{ conflict.time1 }}</span>
                                <span class="mx-2 text-gray-400">|</span>
                                <span class="text-xs font-semibold text-red-800">{{ conflict.subject1 }}</span>
                            </div>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7" />
                            </svg>
                            <div class="items-center bg-red-50 px-3 py-1 rounded-full">
                                <span class="text-xs font-medium text-red-700">{{ conflict.time2 }}</span>
                                <span class="mx-2 text-gray-400">|</span>
                                <span class="text-xs font-semibold text-red-800">{{ conflict.subject2 }}</span>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    {% for room, day_schedule in room_schedule.items %}
    <div class="mb-12 bg-white rounded-xl shadow-md overflow-hidden" id="room-{{ room|slugify }}">
        <div class="bg-gray-50 px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-xl font-semibold text-gray-800 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-500 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                    </svg>
                    Room {{ room }}
                </h3>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6 text-blue-500 hover:text-blue-700 cursor-pointer print-room" data-room="{{ room }}">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6.72 13.829c-.24.03-.48.062-.72.096m.72-.096a42.415 42.415 0 0 1 10.56 0m-10.56 0L6.34 18m10.94-4.171c.24.03.48.062.72.096m-.72-.096L17.66 18m0 0 .229 2.523a1.125 1.125 0 0 1-1.12 1.227H7.231c-.662 0-1.18-.568-1.12-1.227L6.34 18m11.318 0h1.091A2.25 2.25 0 0 0 21 15.75V9.456c0-1.081-.768-2.015-1.837-2.175a48.055 48.055 0 0 0-1.913-.247M6.34 18H5.25A2.25 2.25 0 0 1 3 15.75V9.456c0-1.081.768-2.015 1.837-2.175a48.041 48.041 0 0 1 1.913-.247m10.5 0a48.536 48.536 0 0 0-10.5 0m10.5 0V3.375c0-.621-.504-1.125-1.125-1.125h-8.25c-.621 0-1.125.504-1.125 1.125v3.659M18 10.5h.008v.008H18V10.5Zm-3 0h.008v.008H15V10.5Z" />
                </svg>
        </div>
        
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-50">
                    <tr>
                        {% for day in days %}
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            <div class="flex items-center">
                                <span>{{ day }}</span>
                            </div>
                        </th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-100">
                    <tr>
                        {% for day in days %}
                        <td class="px-4 py-4 align-top min-w-[220px]">
                            <div class="space-y-3 h-full">
                                {% for item in day_schedule|get_item:day %}
                                <div class="relative p-4 rounded-lg border transition-all duration-200
                                    {% if item.assign_id in conflict_ids %}
                                    border-red-300 bg-red-50 shadow-red-100 shadow-sm
                                    {% else %}
                                    border-gray-200 bg-white hover:border-blue-200 hover:shadow-md
                                    {% endif %}">
                                    
                                    {% if item.assign_id in conflict_ids %}
                                    <div class="absolute -top-2 -right-2">
                                        <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-red-500 text-white text-xs font-bold">
                                            !
                                        </span>
                                    </div>
                                    {% endif %}
                                    
                                    <div class="flex justify-between items-start">
                                        <div class="w-2/4 min-w-0">
                                            <h4 class="text-sm font-semibold 
                                                {% if item.assign_id in conflict_ids %}text-red-700{% else %}text-gray-800{% endif %}">
                                                {{ item.semester.subject }}
                                            </h4>
                                            <p class="text-xs text-gray-500 mt-1">{{ item.semester.major_class }}</p>
                                        </div>
                                        <span class="text-xs px-2 py-1 rounded-full
                                            {% if item.assign_id in conflict_ids %}
                                            bg-red-100 text-red-800
                                            {% else %}
                                            bg-blue-100 text-blue-800
                                            {% endif %}">
                                            {{ item.start_time|time:"H:i" }}-{{ item.end_time|time:"H:i" }}
                                        </span>
                                    </div>
                                    
                                    <div class="mt-2 text-xs text-gray-600 space-y-1">
                                        <p class="truncate">{{ item.semester.program_session }} â€¢ {{ item.semester.major }}</p>
                                        <p class="font-medium text-gray-700">
                                            {{ item.semester.lecturer_1 }}
                                            {% if item.semester.lecturer_2 %}, {{ item.semester.lecturer_2 }}{% endif %}
                                        </p>
                                    </div>
                                    <div class="absolute bottom-2 right-2">
                                        <button class="remove-schedule" 
                                                data-assign-id="{{ item.assign_id }}" 
                                                data-semester-id="{{ item.semester.semester_id }}"
                                                data-semester-url="20252">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-red-500 hover:text-red-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                            </svg>
                                        </button>
                                    </div>
                                    {% if item.assign_id in conflict_ids %}
                                    <div class="mt-2 flex items-center text-xs font-medium text-red-600">
                                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                        </svg>
                                        Schedule conflict - please resolve
                                    </div>
                                    {% endif %}
                                </div>
                                {% empty %}
                                <div class="h-40 flex flex-col items-center justify-center text-gray-400">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                    <span class="text-sm">No classes scheduled</span>
                                </div>
                                {% endfor %}
                            </div>
                        </td>
                        {% endfor %}
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    {% endfor %}
</main>

<style>
    .shadow-xs {
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    }
    table {
        min-width: 100%;
    }
    td {
        vertical-align: top;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const roomSearch = document.getElementById('roomSearch');
    const roomCards = document.querySelectorAll('[class*="mb-12 bg-white rounded-xl"]'); 
    
    roomSearch.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        
        roomCards.forEach(card => {
            const roomTitle = card.querySelector('h3').textContent.toLowerCase();
            if (roomTitle.includes(searchTerm)) {
                card.style.display = 'block';
            } else {
                card.style.display = 'none';
            }
        });
    });
});


document.querySelectorAll('.remove-schedule').forEach(button => {
    button.addEventListener('click', function() {
        const assignId = this.getAttribute('data-assign-id');
        const semesterId = this.getAttribute('data-semester-id');
        const semesterUrl = this.getAttribute('data-semester-url');
        
        Swal.fire({
            title: 'Are you sure?',
            text: "You won't be able to revert this!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Yes, delete it!'
        }).then((result) => {
            if (result.isConfirmed) {
                Swal.fire({
                    title: 'Deleting...',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });
                fetch("{% url 'schedulelecturer_delete' %}", {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json',
                    },
                     body: JSON.stringify({
                        assign_id: assignId,
                        semester_id: semesterId,
                        semester_url: semesterUrl
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        Swal.close();
                        
                        Swal.fire({
                            position: "top-end",
                            icon: "success",
                            title: "Schedule deleted successfully",
                            showConfirmButton: false,
                            timer: 1500
                        }).then(() => {
                            button.closest('.relative').remove();
                        
                            if (window.opener) {
                                window.opener.postMessage({
                                    type: 'UPDATE_SEMESTER_STATUS',
                                    semester_id: semesterId,
                                    status: 'pending'
                                }, '*');
                            }
                            
                            window.location.reload();
                        });
                    } else {
                        throw new Error(data.error || 'Unknown error');
                    }
                })
                .catch(error => {
                    console.error('Delete error:', error);
                    Swal.fire({
                        position: "top-end",
                        icon: "error",
                        title: "Delete failed",
                        text: error.message,
                        showConfirmButton: false,
                        timer: 2000
                    });
                });
            }
        });
    });
});


const { jsPDF } = window.jspdf;

document.querySelectorAll('.print-room').forEach(button => {
    button.addEventListener('click', function() {
        const roomName = this.getAttribute('data-room');
        const roomElement = document.getElementById(`room-${roomName.toLowerCase().replace(/ /g, '-')}`);
         
        Swal.fire({
            title: 'Export Room Schedule',
            text: 'Choose export option for ' + roomName,
            showCancelButton: true,
            confirmButtonText: 'Download PDF',
            cancelButtonText: 'Cancel'
        }).then((result) => {
           if (result.isConfirmed) {
                downloadAsPDF(roomElement, roomName);
            }
        });
    });
});

function downloadAsPDF(element, roomName) {
    const pdf = new jsPDF('l', 'mm', 'a4');
    
    pdf.setFontSize(14);
    pdf.text(`Schedule Report 20252 by : ${roomName}`, 148, 15, { align: 'center' });
    
    const timeSlots = [
        '07:00-07:50', '07:50-08:40', '08:40-09:30', '09:30-10:20', '10:20-11:10', 
        '11:10-12:00', '12:00-12:50', '12:50-13:40', '13:40-14:30', '14:30-15:20',
        '15:20-16:10', '16:10-17:00', '17:00-17:50', '17:50-18:40', '18:40-19:30',
        '19:30-20:20', '20:20-21:10', '21:10-22:00', '22:00-22:50', '22:50-23:40'
    ];
    
    const dayHeaders = ['Time', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri'];
    
    function timeToMinutes(time) {
        const [hours, minutes] = time.split(':').map(Number);
        return hours * 60 + minutes;
    }
    
    const scheduleData = {};
    const tds = element.querySelectorAll('tbody td');
    const uniqueSchedules = new Set();

    tds.forEach((td, dayIndex) => {
        const dayName = dayHeaders[dayIndex + 1];
        if (!dayName) return;
        
        scheduleData[dayName] = [];
        
        td.querySelectorAll('.relative').forEach(scheduleItem => {
            const subject = scheduleItem.querySelector('h4')?.innerText.trim() || '';
            const classInfo = scheduleItem.querySelector('p.text-xs')?.innerText.trim() || '';
            const timeSpan = scheduleItem.querySelector('span.text-xs')?.innerText.trim() || '';
            const lecturer = scheduleItem.querySelector('.mt-2 p.font-medium')?.innerText.trim() || '';
            
            const timeMatch = timeSpan.match(/(\d{2}:\d{2})-(\d{2}:\d{2})/);
            if (timeMatch) {
                const scheduleKey = `${dayName}-${timeMatch[1]}-${timeMatch[2]}-${subject}-${lecturer}`;
                
                if (!uniqueSchedules.has(scheduleKey)) {
                    uniqueSchedules.add(scheduleKey);
                    scheduleData[dayName].push({
                        subject,
                        classInfo,
                        startTime: timeMatch[1],
                        endTime: timeMatch[2],
                        lecturer,
                        fullText: `${subject}\n${classInfo}\n${lecturer}`
                    });
                }
            }
        });
    });

    const tableData = [];
    const mergedCells = {};
    
    timeSlots.forEach((timeSlot, rowIndex) => {
        const row = [timeSlot];
        const [slotStart, slotEnd] = timeSlot.split('-');
        const slotStartMin = timeToMinutes(slotStart);
        const slotEndMin = timeToMinutes(slotEnd);
        
        dayHeaders.slice(1).forEach((day, dayIndex) => {
            const cellKey = `${rowIndex}-${dayIndex}`;
            
            if (mergedCells[cellKey]) {
                row.push('');
                return;
            }
            
            let cellContent = '';
            let spanRows = 1;
            
            if (scheduleData[day]) {
                for (const item of scheduleData[day]) {
                    const itemStartMin = timeToMinutes(item.startTime);
                    const itemEndMin = timeToMinutes(item.endTime);

                    if (itemStartMin < slotEndMin && itemEndMin > slotStartMin && 
                        itemStartMin <= slotStartMin) {
                        
                        const overlappingSlots = [];
                        for (let i = rowIndex; i < timeSlots.length; i++) {
                            const [tsStart, tsEnd] = timeSlots[i].split('-');
                            const tsStartMin = timeToMinutes(tsStart);
                            const tsEndMin = timeToMinutes(tsEnd);
                            
                            if (itemStartMin < tsEndMin && itemEndMin > tsStartMin) {
                                overlappingSlots.push(i);
                            } else {
                                break;
                            }
                        }
                        
                        spanRows = overlappingSlots.length;
                        cellContent = `${item.startTime}-${item.endTime}\n${item.fullText}`;
                        
                        for (let i = 1; i < spanRows; i++) {
                            mergedCells[`${rowIndex + i}-${dayIndex}`] = true;
                        }
                        break;
                    }
                }
            }
            
            row.push(cellContent);
        });
        
        tableData.push(row);
    });
    
    pdf.autoTable({
        startY: 20,
        head: [dayHeaders],
        body: tableData,
        styles: {
            fontSize: 8,
            cellPadding: 3,
            valign: 'middle',
            halign: 'center',
            overflow: 'linebreak',
            lineWidth: 0.1,
            fillColor: false
        },
        columnStyles: {
            0: { cellWidth: 22, fontStyle: 'bold' },
            1: { cellWidth: 50 },
            2: { cellWidth: 50 },
            3: { cellWidth: 50 },
            4: { cellWidth: 50 },
            5: { cellWidth: 50 }
        },
        theme: 'plain',
        didDrawCell: function(data) {
            if (data.column.index > 0 && mergedCells[`${data.row.index}-${data.column.index - 1}`]) {
                pdf.setDrawColor(255, 255, 255);
                pdf.line(data.cell.x, data.cell.y, data.cell.x + data.cell.width, data.cell.y);
                pdf.line(data.cell.x, data.cell.y + data.cell.height, 
                        data.cell.x + data.cell.width, data.cell.y + data.cell.height);
            }
        }
    });
    
    pdf.save(`Schedule_${roomName.replace(/ /g, '_')}.pdf`);
}
</script>

{% endblock %}

